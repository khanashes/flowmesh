syntax = "proto3";

package flowmesh.v1;

option go_package = "github.com/flowmesh/engine/api/proto/flowmeshpb";

// ResourcePath represents a hierarchical resource path
message ResourcePath {
  string tenant = 1;
  string namespace = 2;
  string resource_type = 3; // "stream", "queue", "kv"
  string name = 4;
}

// Status represents operation status
message Status {
  int32 code = 1;      // HTTP/gRPC status code
  string message = 2;  // Human-readable error message
  string details = 3;  // Additional error details
}

// HealthCheckRequest is a request for health check
message HealthCheckRequest {
}

// HealthCheckResponse is a response for health check
message HealthCheckResponse {
  Status status = 1;
}

// ReadinessCheckRequest is a request for readiness check
message ReadinessCheckRequest {
}

// ReadinessCheckResponse is a response for readiness check
message ReadinessCheckResponse {
  Status status = 1;
  bool ready = 2;
}

// HealthService provides health and readiness checks
service HealthService {
  // HealthCheck checks if the server is running
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);

  // ReadinessCheck checks if the server is ready to serve requests
  rpc ReadinessCheck(ReadinessCheckRequest) returns (ReadinessCheckResponse);
}

// Event represents an event to be written to a stream
message Event {
  bytes payload = 1;                    // Event payload
  map<string, string> headers = 2;      // Event headers/metadata
}

// Message represents a message read from a stream
message Message {
  string id = 1;                         // Globally unique message ID
  string resource_path = 2;              // Resource path
  int32 partition = 3;                   // Partition ID
  int64 offset = 4;                      // Offset within partition
  bytes payload = 5;                     // Message payload
  map<string, string> headers = 6;      // Message headers
  int64 created_at = 7;                  // Creation timestamp (Unix nanoseconds)
  int32 schema_version = 8;               // Schema version
}

// WriteEventsRequest is a request to write events to a stream
message WriteEventsRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  repeated Event events = 2;              // Events to write
}

// WriteEventsResponse is a response to writing events
message WriteEventsResponse {
  Status status = 1;                      // Operation status
  repeated int64 offsets = 2;             // Assigned offsets for each event
}

// ReadStreamRequest is a request to read messages from a stream
message ReadStreamRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  int32 partition = 2;                   // Partition ID (default: 0)
  int64 offset = 3;                      // Starting offset
  int32 max_messages = 4;                 // Maximum number of messages to return
}

// ReadStreamResponse is a response to reading from a stream
message ReadStreamResponse {
  Status status = 1;                      // Operation status
  repeated Message messages = 2;          // Messages read
}

// SubscribeRequest is a request to subscribe to a stream with consumer group
message SubscribeRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  string consumer_group = 2;             // Consumer group name
  int32 partition = 3;                   // Partition ID (default: 0)
  int64 start_offset = 4;                // Starting offset (-1 for committed offset, -2 for latest)
}

// SubscribeResponse is a streamed response for subscription
message SubscribeResponse {
  Message message = 1;                   // Streamed message
  Status status = 2;                    // Status (only set on error)
}

// CommitOffsetRequest is a request to commit a consumer group offset
message CommitOffsetRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  string consumer_group = 2;             // Consumer group name
  int32 partition = 3;                   // Partition ID (default: 0)
  int64 offset = 4;                      // Offset to commit
}

// CommitOffsetResponse is a response to committing an offset
message CommitOffsetResponse {
  Status status = 1;                      // Operation status
}

// GetOffsetRequest is a request to get a committed offset
message GetOffsetRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  string consumer_group = 2;             // Consumer group name
  int32 partition = 3;                   // Partition ID (default: 0)
}

// GetOffsetResponse is a response to getting an offset
message GetOffsetResponse {
  Status status = 1;                      // Operation status
  int64 offset = 2;                      // Committed offset (-1 if no commits yet)
}

// GetLatestOffsetRequest is a request to get the latest offset for a stream
message GetLatestOffsetRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  int32 partition = 2;                   // Partition ID (default: 0)
}

// GetLatestOffsetResponse is a response to getting the latest offset
message GetLatestOffsetResponse {
  Status status = 1;                      // Operation status
  int64 offset = 2;                      // Latest offset (-1 if no messages)
}

// ConsumerGroupState represents the state of a consumer group
message ConsumerGroupState {
  string stream = 1;                      // Stream resource path
  string group = 2;                       // Consumer group name
  int32 partition = 3;                    // Partition ID
  int64 committed_offset = 4;             // Last committed offset (-1 if no commits)
  int64 latest_offset = 5;                // Latest available offset (-1 if no messages)
  int64 lag = 6;                          // Calculated lag
}

// GetConsumerGroupStateRequest is a request to get consumer group state
message GetConsumerGroupStateRequest {
  ResourcePath resource_path = 1;        // Stream resource path
  string consumer_group = 2;             // Consumer group name
  int32 partition = 3;                   // Partition ID (default: 0)
}

// GetConsumerGroupStateResponse is a response to getting consumer group state
message GetConsumerGroupStateResponse {
  Status status = 1;                      // Operation status
  ConsumerGroupState state = 2;           // Consumer group state
}

// StreamService provides operations for working with streams
service StreamService {
  // WriteEvents writes multiple events to a stream and returns assigned offsets
  rpc WriteEvents(WriteEventsRequest) returns (WriteEventsResponse);

  // ReadStream reads messages from a stream starting at a specific offset
  rpc ReadStream(ReadStreamRequest) returns (ReadStreamResponse);

  // Subscribe subscribes to a stream with consumer group support (server-side streaming)
  rpc Subscribe(SubscribeRequest) returns (stream SubscribeResponse);

  // CommitOffset commits an offset for a consumer group
  rpc CommitOffset(CommitOffsetRequest) returns (CommitOffsetResponse);

  // GetOffset retrieves the committed offset for a consumer group
  rpc GetOffset(GetOffsetRequest) returns (GetOffsetResponse);

  // GetLatestOffset retrieves the latest offset for a stream partition
  rpc GetLatestOffset(GetLatestOffsetRequest) returns (GetLatestOffsetResponse);

  // GetConsumerGroupState retrieves the complete state of a consumer group including lag
  rpc GetConsumerGroupState(GetConsumerGroupStateRequest) returns (GetConsumerGroupStateResponse);
}

// Job represents a job in a queue
message Job {
  string id = 1;                         // Unique job identifier
  string resource_path = 2;              // Queue resource path
  int64 seq = 3;                         // Sequence number in queue log
  bytes payload = 4;                     // Job payload
  map<string, string> headers = 5;      // Job headers/metadata
  int64 created_at = 6;                  // Creation timestamp (Unix nanoseconds)
  int64 visible_at = 7;                  // When job becomes visible (Unix nanoseconds)
  int64 reserve_until = 8;              // When visibility timeout expires (Unix nanoseconds, 0 if not reserved)
  int32 attempts = 9;                    // Number of delivery attempts
}

// EnqueueRequest is a request to enqueue a job to a queue
message EnqueueRequest {
  ResourcePath resource_path = 1;        // Queue resource path
  bytes payload = 2;                     // Job payload
  int64 delay_seconds = 3;               // Delay before job becomes visible (seconds, default: 0)
  map<string, string> headers = 4;       // Job headers/metadata
}

// EnqueueResponse is a response to enqueueing a job
message EnqueueResponse {
  Status status = 1;                      // Operation status
  string job_id = 2;                      // Assigned job ID
  int64 seq = 3;                          // Sequence number
}

// ReserveRequest is a request to reserve a job from a queue
message ReserveRequest {
  ResourcePath resource_path = 1;        // Queue resource path
  int64 visibility_timeout_seconds = 2;  // Visibility timeout in seconds (default: 30)
  int64 long_poll_timeout_seconds = 3;   // Long poll timeout in seconds (0 = no wait, default: 0)
}

// ReserveResponse is a response to reserving a job
message ReserveResponse {
  Status status = 1;                      // Operation status
  Job job = 2;                            // Reserved job (null if no jobs available)
}

// ReceiveRequest is a request to receive multiple jobs from a queue
message ReceiveRequest {
  ResourcePath resource_path = 1;        // Queue resource path
  int32 max_jobs = 2;                     // Maximum number of jobs to receive (1-100, default: 1)
  int64 visibility_timeout_seconds = 3;  // Visibility timeout in seconds (default: 30)
  int64 long_poll_timeout_seconds = 4;   // Long poll timeout in seconds (0 = no wait, default: 0)
}

// ReceiveResponse is a response to receiving jobs
message ReceiveResponse {
  Status status = 1;                      // Operation status
  repeated Job jobs = 2;                  // Received jobs
}

// ACKRequest is a request to acknowledge completion of a job
message ACKRequest {
  ResourcePath resource_path = 1;        // Queue resource path
  string job_id = 2;                      // Job ID to acknowledge
}

// ACKResponse is a response to acknowledging a job
message ACKResponse {
  Status status = 1;                      // Operation status
}

// NACKRequest is a request to negatively acknowledge a job
message NACKRequest {
  ResourcePath resource_path = 1;        // Queue resource path
  string job_id = 2;                      // Job ID to NACK
  int64 delay_seconds = 3;               // Optional delay before requeue (seconds, 0 = use backoff)
}

// NACKResponse is a response to NACKing a job
message NACKResponse {
  Status status = 1;                      // Operation status
}

// QueueStats represents statistics for a queue
message QueueStats {
  int64 total_jobs = 1;                  // Total jobs ever enqueued
  int64 pending_jobs = 2;                // Jobs in ready heap (waiting to be processed)
  int64 in_flight_jobs = 3;              // Jobs currently being processed
  int64 completed_jobs = 4;              // Successfully completed jobs
  int64 failed_jobs = 5;                 // Failed jobs
  int64 oldest_job_age_seconds = 6;      // Age of oldest pending job in seconds
}

// GetQueueStatsRequest is a request to get queue statistics
message GetQueueStatsRequest {
  ResourcePath resource_path = 1;        // Queue resource path
}

// GetQueueStatsResponse is a response to getting queue statistics
message GetQueueStatsResponse {
  Status status = 1;                      // Operation status
  QueueStats stats = 2;                   // Queue statistics
}

// QueueService provides operations for working with queues
service QueueService {
  // Enqueue enqueues a job to a queue and returns job ID and sequence number
  rpc Enqueue(EnqueueRequest) returns (EnqueueResponse);

  // Reserve reserves a single job from the queue with visibility timeout
  rpc Reserve(ReserveRequest) returns (ReserveResponse);

  // Receive receives multiple jobs from the queue (batch receive)
  rpc Receive(ReceiveRequest) returns (ReceiveResponse);

  // ACK acknowledges completion of a job
  rpc ACK(ACKRequest) returns (ACKResponse);

  // NACK negatively acknowledges a job (requeue with backoff)
  rpc NACK(NACKRequest) returns (NACKResponse);

  // GetQueueStats retrieves queue statistics (depth, in-flight, age, etc.)
  rpc GetQueueStats(GetQueueStatsRequest) returns (GetQueueStatsResponse);
}

