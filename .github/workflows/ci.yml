name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22', '1.23']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      working-directory: ./engine
      run: go mod download

    - name: Verify dependencies
      working-directory: ./engine
      run: go mod verify

    - name: Run tests
      working-directory: ./engine
      run: go test -v -race -coverprofile=coverage.out ./...

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      if: matrix.go-version == '1.23'
      with:
        file: ./engine/coverage.out
        flags: unittests
        name: codecov-umbrella

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Install golangci-lint
      run: |
        curl -sSfL https://golangci-lint.run/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.7.2
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Run golangci-lint
      working-directory: ./engine
      run: golangci-lint run --timeout=5m ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Get version
      id: version
      run: |
        VERSION=$(cat VERSION 2>/dev/null || echo "dev")
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build binary
      working-directory: ./engine
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        BINARY_NAME=flowmesh
        if [ "${{ matrix.goos }}" = "windows" ]; then
          BINARY_NAME=flowmesh.exe
        fi
        mkdir -p ../bin/${{ matrix.goos }}-${{ matrix.goarch }}
        go build -o ../bin/${{ matrix.goos }}-${{ matrix.goarch }}/$BINARY_NAME \
          -ldflags "-X github.com/flowmesh/engine/internal/version.Version=${{ steps.version.outputs.version }}" \
          ./cmd/flowmesh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flowmesh-${{ matrix.goos }}-${{ matrix.goarch }}
        path: bin/${{ matrix.goos }}-${{ matrix.goarch }}/
        retention-days: 7

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Check formatting
      working-directory: ./engine
      run: |
        if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
          echo "Code is not formatted. Please run 'make fmt'"
          gofmt -l .
          exit 1
        fi

